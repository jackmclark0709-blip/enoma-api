<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Enoma — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="dashboard.css" />
</head>

<body>
  <main class="container">
   <header class="header">
  <div>
    <h1 id="business-name">Loading…</h1>
    <p class="sub">Your Enoma page performance</p>
  </div>

  <div class="header-actions">
    <a id="public-link" class="btn" target="_blank">View public page</a>
    <button id="sign-out" class="btn secondary">Sign out</button>
  </div>
</header>


    <section class="status">
      <span id="subscription-status" class="pill">Active</span>
      <span id="renewal-date" class="muted"></span>
    </section>

    <section class="kpis">
      <div class="card">
        <h3>Page Views (30 days)</h3>
        <div id="page-views" class="metric">—</div>
      </div>
      <div class="card">
        <h3>Contact Clicks (30 days)</h3>
        <div id="contact-clicks" class="metric">—</div>
      </div>
    </section>

    <section class="card">
      <h3>Where people found you</h3>
      <ul id="sources"></ul>
    </section>
  </main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="module">
  const SUPABASE_URL = 'https://qhsivcenpnxwmvwznqie.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFoc2l2Y2VucG54d212d3pucWllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2ODQ4NjMsImV4cCI6MjA4MDI2MDg2M30.g_3eHoqfo7R15Q_9OoBy0DTq66a3BPA838VFd1aZtnc';

  const supabase = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );

  // 🚨 DO NOT run dashboard logic immediately
  supabase.auth.onAuthStateChange(async (event, session) => {
    if (!session) {
      window.location.href = "/dashboard/login.html";
      return;
    }

    console.log("Auth ready:", session.user.email);

    await loadDashboard(session);
  });

  async function loadDashboard(session) {
    // 1️⃣ Resolve profile
    const { data: profile, error } = await supabase
      .from("small_business_profiles")
      .select("username, business_name")
      .eq("auth_id", session.user.id)
      .single();

    console.log("Resolved profile:", profile);

    if (error || !profile) {
      console.error("Profile lookup failed", error);
      return;
    }

    // Header
    document.getElementById("business-name").textContent =
      profile.business_name || profile.username;

    const publicLink = document.getElementById("public-link");
    publicLink.href = `/p/${profile.username}`;
    publicLink.style.display = "inline-block";

    // 2️⃣ Metrics (30 days)
    const since = new Date();
    since.setDate(since.getDate() - 30);

    const { count: pageViews } = await supabase
      .from("page_events")
      .select("*", { count: "exact", head: true })
      .eq("slug", profile.username)
      .eq("event", "page_view")
      .gte("created_at", since.toISOString());

    const { count: contactClicks } = await supabase
      .from("page_events")
      .select("*", { count: "exact", head: true })
      .eq("slug", profile.username)
      .eq("event", "contact_click")
      .gte("created_at", since.toISOString());

    document.getElementById("page-views").textContent = pageViews ?? 0;
    document.getElementById("contact-clicks").textContent = contactClicks ?? 0;

    // 3️⃣ Sources
    const { data: sources } = await supabase
      .from("page_events")
      .select("referrer")
      .eq("slug", profile.username)
      .eq("event", "page_view");

    const ul = document.getElementById("sources");
    ul.innerHTML = "";

    const totals = {};
    sources?.forEach((s) => {
      const key = s.referrer || "direct";
      totals[key] = (totals[key] || 0) + 1;
    });

    Object.entries(totals).forEach(([source, visits]) => {
      const li = document.createElement("li");
      li.innerHTML = `<span>${source}</span><strong>${visits}</strong>`;
      ul.appendChild(li);
    });

    // 4️⃣ Sign out
    document.getElementById("sign-out").addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "/dashboard/login.html";
    });
  }
</script>


</body>
</html>
