<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Enoma — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="dashboard.css" />
<link rel="stylesheet" href="/styles/enoma.css">

</head>

<body>
  <main class="container">
   <header class="header">
  <div>
    <h1 id="business-name">Loading…</h1>
    <p class="sub">Your Enoma page performance</p>
  </div>

  <div class="header-actions">
    <a id="public-link" class="btn" target="_blank">View public page</a>
    <button id="sign-out" class="btn secondary">Sign out</button>
  </div>
</header>


    <section class="status">
      <span id="subscription-status" class="pill">Active</span>
      <span id="renewal-date" class="muted"></span>
    </section>

    <section class="kpis">
      <div class="card">
        <h3>Page Views (30 days)</h3>
        <div id="page-views" class="metric">—</div>
      </div>
      <div class="card">
        <h3>Contact Clicks (30 days)</h3>
        <div id="contact-clicks" class="metric">—</div>
      </div>
    </section>

    <section class="card">
      <h3>Where people found you</h3>
      <ul id="sources"></ul>
    </section>
  </main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script type="module">
  const SUPABASE_URL = 'https://qhsivcenpnxwmvwznqie.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFoc2l2Y2VucG54d212d3pucWllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2ODQ4NjMsImV4cCI6MjA4MDI2MDg2M30.g_3eHoqfo7R15Q_9OoBy0DTq66a3BPA838VFd1aZtnc';

  const supabase = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );

  async function main() {
    // 1️⃣ Auth
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      window.location.href = '/login';
      return;
    }

    console.log('Authenticated as:', session.user.email);

    // 2️⃣ Membership
    const { data: member, error: memberError } = await supabase
      .from('business_members')
      .select('*')
      .eq('user_id', session.user.id)
      .single();

    if (memberError) {
      console.error('Membership lookup failed', memberError);
      return;
    }

    // 3️⃣ Status pill
    const statusEl = document.getElementById('subscription-status');
    statusEl.textContent = member.role === 'admin' ? 'Admin' : 'Free';

// 4️⃣ Public profile (via business_id)
const { data: profile, error: profileError } = await supabase
  .from('small_business_profiles')
  .select('username, business_name')
  .eq('business_id', member.business_id)
  .single();

if (profileError || !profile) {
  console.error('Profile lookup failed', profileError);
  return;
}

const businessNameEl = document.getElementById('business-name');
businessNameEl.textContent =
  profile.business_name || profile.username || 'Your business';


    const publicLink = document.getElementById('public-link');
    if (!profile?.username) {
      publicLink.style.display = 'none';
    } else {
      publicLink.href = `/p/${profile.username}`;
      publicLink.style.display = 'inline-block';
    }

    // 4b️⃣ Metrics (from page_events)
    const slug = profile?.username;
    if (slug) {
      const since = new Date();
      since.setDate(since.getDate() - 30);

      // Page views
      const { count: pageViews, error: pvErr } = await supabase
        .from('page_events')
        .select('*', { count: 'exact', head: true })
        .eq('slug', slug)
        .eq('event', 'page_view')
        .gte('created_at', since.toISOString());

      if (pvErr) console.error('page_views query failed', pvErr);

      // Contact clicks
      const { count: contactClicks, error: ccErr } = await supabase
        .from('page_events')
        .select('*', { count: 'exact', head: true })
        .eq('slug', slug)
        .eq('event', 'contact_click')
        .gte('created_at', since.toISOString());

      if (ccErr) console.error('contact_clicks query failed', ccErr);

      document.getElementById('page-views').textContent = pageViews ?? 0;
      document.getElementById('contact-clicks').textContent = contactClicks ?? 0;

      // Sources (referrer breakdown)
      const { data: srcRows, error: srcErr } = await supabase
        .from('page_events')
        .select('referrer')
        .eq('slug', slug)
        .eq('event', 'page_view')
        .gte('created_at', since.toISOString());

      if (srcErr) console.error('sources query failed', srcErr);

      const totals = {};
      (srcRows || []).forEach(r => {
        const key = r.referrer || 'direct';
        totals[key] = (totals[key] || 0) + 1;
      });

      const ul = document.getElementById('sources');
      ul.innerHTML = '';

      Object.entries(totals)
        .sort((a, b) => b[1] - a[1])
        .forEach(([source, visits]) => {
          const li = document.createElement('li');
          li.innerHTML = `<span>${source}</span><strong>${visits}</strong>`;
          ul.appendChild(li);
        });

      // If no sources yet, show a friendly empty state
      if (!Object.keys(totals).length) {
        ul.innerHTML = `<li><span class="muted">No traffic yet (last 30 days)</span></li>`;
      }
    }


    // 5️⃣ Sign out
    document.getElementById('sign-out').addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = '/login';
    });
  }

  // 🚀 Run dashboard
  main();
</script>


</body>
</html>
